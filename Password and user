---
- name: Configure osadmin with passwordless SSH and sudo
  hosts: newservers
  become: true
  tasks:

    - name: Ensure osadmin user exists
      ansible.builtin.user:
        name: osadmin
        state: present
        shell: /bin/bash

    - name: Create .ssh directory
      ansible.builtin.file:
        path: /home/osadmin/.ssh
        state: directory
        owner: osadmin
        group: osadmin
        mode: '0700'

    - name: Add public key to authorized_keys
      ansible.builtin.authorized_key:
        user: osadmin
        state: present
        key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

    - name: Give passwordless sudo to osadmin
      ansible.builtin.copy:
        dest: /etc/sudoers.d/osadmin
        content: "osadmin ALL=(ALL) NOPASSWD: ALL"
        owner: root
        group: root
        mode: '0440'
        validate: '/usr/sbin/visudo -cf %s'

=====================
