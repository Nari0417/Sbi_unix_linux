======================================================================================================================
                      ðŸ‘‰ DR GitLab DB is not empty (DR GitLab already has old data)
                      ðŸ‘‰ DB schema mismatch  (Backup taken from different GitLab version and restored on another version)
                      ðŸ‘‰ Restore started when GitLab was not fully stopped
=======================================================================================================================

link https://gitlab.com/gitlab-org/gitlab/-/issues/36405

My customer (internal link) was seeing this error, all the commands below were producing this error:

sudo gitlab-rake gitlab:check
sudo gitalb-rake db:reset
sudo gitlab-rake gitlab:backup:restore


gitalb-rake db:reset is supposed to drop and create the database, but since it was producing this error, we had to manually drop the database and create it, and that served as a workaround to the issue, we used the following snippet:

# Start the database console
gitlab-psql

# Switch to another database
\c postgres

# Drop all connections to `gitlabhq_production`
select pg_terminate_backend(pid) from pg_stat_activity where datname='gitlabhq_production';

# Drop and create the DB
drop database gitlabhq_production;
\q 
\q

# Perform the restore
sudo gitlab-rake gitlab:backup:restore


Here's the snippet as part of a bash script:

gitlab-psql <<EOF
\c postgres
select pg_terminate_backend(pid) from pg_stat_activity where datname='gitlabhq_production';
drop database gitlabhq_production;
create database gitlabhq_production;
EOF





====================================================================================================================================================================================================================

[root@secrlmsdmgr1 ~]# crontab -l
10 * * * * setfacl â€“Rm u:splunk:rX,d:u:splunk:rX /var/log
00 05 * * * find /rlms/git_backup/*gitlab_backup*.tar -mtime +3 -exec rm -rf {} \;
#00 04 * * * find /rlms/git_backup/* -mtime +3 -exec rm {} \;
#55 10 * * 5 sh /opt/git.sh
00 06 * * * sh /opt/git.sh
00 05 * * * find /var/opt/gitlab/git-data/repositories/+gitaly/tmp/default-repositories.old.* -mtime +15 -exec rm -fr {} \;
[root@secrlmsdmgr1 ~]#
======================================================================================================================

gitlab-rake restore   ------------>internally works
       â”‚
       â”œâ”€â”€ 1) Stop GitLab services (NOT PostgreSQL)
       â”œâ”€â”€ 2) Extract backup tar
       â”œâ”€â”€ 3) Check version compatibility
       â”œâ”€â”€ 4) Drop + Recreate database
       â”œâ”€â”€ 5) Restore SQL file into PostgreSQL
       â”œâ”€â”€ 6) Restore repositories
       â”œâ”€â”€ 7) Restore uploads, artifacts, registry
       â”œâ”€â”€ 8) Reconfigure GitLab
       â”‚
       â””â”€â”€ GitLab comes online with restored data

==========================================================================================================
                    script
============================================================================================================
#!/bin/bash

# ====== CONFIG ======
BACKUP_FILE="$1"   # pass backup name as argument
LOGFILE="/var/log/gitlab_dr_restore.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

echo "===== DR Restore Started at $DATE =====" >> "$LOGFILE"

if [ -z "$BACKUP_FILE" ]; then
    echo "ERROR: Backup file name required" | tee -a "$LOGFILE"
    exit 1
fi

echo "Stopping GitLab services..." | tee -a "$LOGFILE"
gitlab-ctl stop >> "$LOGFILE" 2>&1

echo "Killing active PostgreSQL sessions..." | tee -a "$LOGFILE"
gitlab-psql <<EOF >> "$LOGFILE" 2>&1
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE datname='gitlabhq_production';
EOF

echo "Dropping existing gitlabhq_production DB..." | tee -a "$LOGFILE"
gitlab-psql <<EOF >> "$LOGFILE" 2>&1
DROP DATABASE IF EXISTS gitlabhq_production;
CREATE DATABASE gitlabhq_production;
EOF

echo "Starting GitLab restore..." | tee -a "$LOGFILE"
gitlab-rake gitlab:backup:restore BACKUP=$BACKUP_FILE >> "$LOGFILE" 2>&1

if [ $? -eq 0 ]; then
    echo "Restore SUCCESS at $DATE" | tee -a "$LOGFILE"
else
    echo "Restore FAILED at $DATE" | tee -a "$LOGFILE"
    exit 1
fi

echo "Reconfiguring GitLab..." | tee -a "$LOGFILE"
gitlab-ctl reconfigure >> "$LOGFILE" 2>&1

echo "Starting GitLab..." | tee -a "$LOGFILE"
gitlab-ctl start >> "$LOGFILE" 2>&1

echo "===== DR Restore Completed Successfully =====" | tee -a "$LOGFILE"




==========================================================================================================================================================================

#!/bin/bash
./opt/git.sh

EXIT_STATUS=echo $?

if [ $EXIT_STATUS -ne 0 ]; then
    echo "/opt/git.sh failed. Running alternative commands for database reset and restore." | tee -a /var/log/gitlab_dr_restore.log
    gitlab-psql  <<EOF
\c postgres
select pg_terminate_backend(pid) from pg_stat_activity where datname='gitlabhq_production';
select pg_terminate_backend(pid) from pg_stat_activity where datname='gitlabhq_production';
drop database gitlabhq_production;
create database gitlabhq_production;
EOF

gitlab-rake gitlab:backup:restore force=yes
else
    echo "/opt/git.sh executed successfully. No alternative actions taken."| tee -a /var/log/gitlab_dr_restore.log
fi


===================================================================================================================
#!/bin/bash

sh /opt/git.sh
EXIT_STATUS=$?

if [ $EXIT_STATUS -ne 0 ]; then
    echo "/opt/git.sh failed. Running alternative commands for database reset and restore." | tee -a /var/log/gitlab_dr_restore.log

    gitlab-psql <<EOF
\c postgres
select pg_terminate_backend(pid) from pg_stat_activity where datname='gitlabhq_production';
drop database gitlabhq_production;
create database gitlabhq_production;
EOF

    gitlab-rake gitlab:backup:restore force=yes
else
    echo "/opt/git.sh executed successfully. No alternative actions taken." | tee -a /var/log/gitlab_dr_restore.log
fi



